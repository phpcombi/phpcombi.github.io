<!DOCTYPE html>
<!--[if lt IE 7]>       <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>          <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>          <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <title>调试与日志 - PHP\Combi</title>
    <meta name="description" content="a php framework" />
    <meta name="author" content="I, Me & Myself">
    <meta charset="UTF-8">
    <link rel="icon" href="../themes/daux/img/favicon-blue.png" type="image/x-icon">
    <!-- Mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font -->
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700&subset=latin,cyrillic-ext,cyrillic' rel='stylesheet' type='text/css'>
    <!-- CSS -->
    <link href='../themes/daux/css/theme-blue.min.css' rel='stylesheet' type='text/css'>
            <!-- Tipue Search -->
        <link href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body class=" ">
    <div class="Columns content">
    <aside class="Columns__left Collapsible">
        <button type="button" class="Button Collapsible__trigger">
            <span class="Collapsible__trigger--bar"></span>
            <span class="Collapsible__trigger--bar"></span>
            <span class="Collapsible__trigger--bar"></span>
        </button>

        <a class="Brand" href="../index.html">PHP\Combi</a>

    <div class="Search">
        <svg class="Search__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 451 451">
            <path d="M447.05 428l-109.6-109.6c29.4-33.8 47.2-77.9 47.2-126.1C384.65 86.2 298.35 0 192.35 0 86.25 0 .05 86.3.05 192.3s86.3 192.3 192.3 192.3c48.2 0 92.3-17.8 126.1-47.2L428.05 447c2.6 2.6 6.1 4 9.5 4s6.9-1.3 9.5-4c5.2-5.2 5.2-13.8 0-19zM26.95 192.3c0-91.2 74.2-165.3 165.3-165.3 91.2 0 165.3 74.2 165.3 165.3s-74.1 165.4-165.3 165.4c-91.1 0-165.3-74.2-165.3-165.4z"/>
        </svg>
        <input type="search" id="tipue_search_input" class="Search__field" placeholder="Search..." autocomplete="on"
               results=25 autosave=text_search>
    </div>

        <div class="Collapsible__content">
            <!-- Navigation -->
            <ul class='Nav'><li class='Nav__item '><a href="../Get_Started.html">Get Started</a></li><li class='Nav__item Nav__item--open has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>框架基础</a><ul class='Nav'><li class='Nav__item '><a href="../框架基础/基础结构.html">基础结构</a></li><li class='Nav__item '><a href="../框架基础/配置系统.html">配置系统</a></li><li class='Nav__item Nav__item--active'><a href="../框架基础/调试与日志.html">调试与日志</a></li><li class='Nav__item '><a href="../框架基础/勾子与语言包.html">勾子与语言包</a></li><li class='Nav__item '><a href="../框架基础/通用中间件.html">通用中间件</a></li><li class='Nav__item '><a href="../框架基础/使用Redis.html">使用Redis</a></li><li class='Nav__item '><a href="../框架基础/Action机制.html">Action机制</a></li><li class='Nav__item '><a href="../框架基础/应用框架.html">应用框架</a></li><li class='Nav__item '><a href="../框架基础/Meta组件.html">Meta组件</a></li><li class='Nav__item '><a href="../框架基础/小工具.html">小工具</a></li></ul></li><li class='Nav__item  has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Web模块</a><ul class='Nav'><li class='Nav__item '><a href="../Web模块/入口.html">入口</a></li><li class='Nav__item '><a href="../Web模块/HTTP消息.html">HTTP消息</a></li><li class='Nav__item '><a href="../Web模块/控制器与路由.html">控制器与路由</a></li><li class='Nav__item '><a href="../Web模块/中间件.html">中间件</a></li><li class='Nav__item '><a href="../Web模块/模版.html">模版</a></li><li class='Nav__item '><a href="../Web模块/协议与错误处理.html">协议与错误处理</a></li><li class='Nav__item '><a href="../Web模块/会话与日志.html">会话与日志</a></li><li class='Nav__item '><a href="../Web模块/测试.html">测试</a></li></ul></li></ul>

            <div class="Links">
                
                                    <div class="CodeToggler">
                        <hr/>
                                                    <a class="CodeToggler__button CodeToggler__button--main" href="#">Show Code Blocks Inline</a><br>
                                            </div>
                
                            </div>
        </div>
    </aside>
    <div class="Columns__right ">
        <div class="Columns__right__content">
            <div class="doc_content">
                <article class="Page">

    <div class="Page__header">
        <h1><a href="../框架基础/基础结构.html">框架基础</a> <svg class="Page__header--separator" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 477.175 477.175"><path d="M360.73 229.075l-225.1-225.1c-5.3-5.3-13.8-5.3-19.1 0s-5.3 13.8 0 19.1l215.5 215.5-215.5 215.5c-5.3 5.3-5.3 13.8 0 19.1 2.6 2.6 6.1 4 9.5 4 3.4 0 6.9-1.3 9.5-4l225.1-225.1c5.3-5.2 5.3-13.8.1-19z"/></svg> <a href="../框架基础/调试与日志.html">调试与日志</a></h1>
                    </div>


    <div class="s-content">
        <ul class="TableOfContents">
<li>
<p><a href="#page_Abort">Abort机制</a></p>
<ul class="TableOfContents">
<li>
<p><a href="#page_abort">使用abort语句</a></p>
</li>
<li>
<p><a href="#page_section_3">原生违例</a></p>
</li>
<li>
<p><a href="#page_section_4">设置中断属性</a></p>
<ul class="TableOfContents">
<li>
<p><a href="#page_section_5">中断消息模版与转换输出</a></p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#page_section_6">调试方法</a></p>
<ul class="TableOfContents">
<li>
<p><a href="#page_Helper">使用Helper类</a></p>
<ul class="TableOfContents">
<li>
<p><a href="#page_Helper-2">Helper扩展方法</a></p>
</li>
</ul>
</li>
<li>
<p><a href="#page_section_8">调试输出</a></p>
<ul class="TableOfContents">
<li>
<p><a href="#page_section_9">调试并中止程序</a></p>
</li>
<li>
<p><a href="#page_section_10">获取代码段执行时间</a></p>
</li>
</ul>
</li>
<li>
<p><a href="#page_section_11">异常捕获</a></p>
<ul class="TableOfContents">
<li>
<p><a href="#page_section_12">错误转违例</a></p>
</li>
<li>
<p><a href="#page_section_13">违例捕获</a></p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#page_section_14">日志系统</a></p>
<ul class="TableOfContents">
<li>
<p><a href="#page_section_15">日志配置</a></p>
</li>
<li>
<p><a href="#page_section_16">记录日志</a></p>
</li>
<li>
<p><a href="#page_section_17">自定义日志对象</a></p>
</li>
<li>
<p><a href="#page_section_18">日志的附加功能</a></p>
</li>
</ul>
</li>
</ul>
<h1 id="page_Abort">Abort机制</h1>
<p>Abort机制是combi默认推荐的一种错误处理方式，特征如下：</p>
<ul>
<li>基于php违例机制设计，通过设置<code>全局捕获</code>与<code>try..catch</code>语法处理抛出的中断消息</li>
<li>推荐通过错误号来识别异常，这样可以更少地定义Exception类，或直接使用SPL提供的几个违例</li>
<li>中断的相关信息均可以在中断发生的地方给出，更自然，通用性好</li>
</ul>
<h2 id="page_abort">使用abort语句</h2>
<p>推荐在combi项目的文件开头加上以下use语句以便于简单地使用中断，脚手架创建的文件会自带该声明。</p>
<pre><code class="language-php">use Combi {
    Abort as abort
};
</code></pre>
<p>当错误发生时，抛出中断：</p>
<pre><code class="language-php">if (!$user) {
    throw abort::unexpectedValue('User is not found', 21001);
}
</code></pre>
<p>如上所示，当用户对象取不到时，抛出错误号为21001的中断，其包含的违例对象为<code>\UnexpectedValueException</code>。这种通过重载创建Abort中断对象的方式，会默认创建根空间下末尾为Exception的违例对象。这主要是针对SPL提供的几个默认违例提供的快捷方式。</p>
<p>如果需要使用其他违例类作为违例实体，可以使用下面的方法 。</p>
<pre><code class="language-php">if (!$user) {
    throw abort::with(new MyException('User is not found', 21001));
}
</code></pre>
<h2 id="page_section_3">原生违例</h2>
<p>违例对象本身主要包括了文字消息与错误号，外加上一个违例及类名等信息。Abort对象本身也是一个违例，在调用abort语句时，会创建一个Abort对象，并将违例实体作为previous参数传给Abort。</p>
<p>当需要获取原生违例时，可以调用getPrevious()方法获取：</p>
<pre><code class="language-php">$raw = $abort-&gt;getPrevious();
</code></pre>
<p>需要判断原生违例类时，abort对象提供了一个简单一点的方法：</p>
<pre><code class="language-php">if ($abort-&gt;class() == UnexpectedValueException::class) {
    // do something..
}
</code></pre>
<h2 id="page_section_4">设置中断属性</h2>
<p>abort机制的目的之一，就是使得不需要通过定义很多的违例类，即可在错误发生的地点把相关的信息传递出来。因此abort对象包含了一个collection对象，假设要违例发生点需要传递用户id，那么可以这么用：</p>
<pre><code class="language-php">$user = User::find($user_id);
if (!$user) {
    throw abort::unexpectedValue('User is not found', 21001)
        -&gt;set('user_id', $user_id);
}
</code></pre>
<p>这样在捕获点，则可以根据传出来的user_id进行处理：</p>
<pre><code class="language-php">try {
    //...
} catch (abort $abort) {
    if ($abort-&gt;getCode() == 21001) {
        // 忽略用户id=100的错误
        if ($abort-&gt;get('user_id') != 100) {
            throw $abort;
        }
    }
}
</code></pre>
<p>中断属性除了提供错误发生时必要的信息，也可以提供其他指导参数，假设我们在业务接口中约定了一个参数show，来控制是否显示此错误。这样在错误发生点，我们可以提供一个推荐的处理方式，比如这里打算隐藏该错误。</p>
<pre><code class="language-php">$user = User::find($user_id);
if (!$user) {
    throw abort::unexpectedValue('User is not found', 21001)
        -&gt;set('user_id', $user_id)
        -&gt;set('show', 0);
}
</code></pre>
<p>像这样，你可以通过多次调用set方法来给中断设置多个要传递的参数。</p>
<h3 id="page_section_5">中断消息模版与转换输出</h3>
<p>中断消息支持combi框架内建的一个简单模版规则。你可以这样描述错误：</p>
<pre><code class="language-php">$abort = abort::unexpectedValue('User {{user_id}} is not found', 21001)
    -&gt;set('user_id', 100)
    -&gt;set('show', 0);
throw $abort;
</code></pre>
<p>这时直接输出<code>$abort</code>你会看到：</p>
<pre><code class="language-php">echo $abort;
// print like this: {&quot;message&quot;:&quot;User 100 is not found&quot;,&quot;code&quot;:21001,&quot;file&quot;:&quot;/src/classes/Core/Abort.php&quot;,&quot;line&quot;:32,&quot;extra&quot;:{&quot;user_id&quot;:100,&quot;show&quot;:0}}
</code></pre>
<p>abort支持几种转换输出的方式：</p>
<pre><code class="language-php">var_dump($abort-&gt;toArray());    // 转换为数组
var_dump($abort);               // 调试输出，结果与上面一致
echo json_encode($abort);       // 转换为json格式
echo $abort;                    // 转换为字串输出，结果与上面一致
</code></pre>
<p>当使用这几种转换方式输出，或是使用combi内建的日志和调试模块的话，message中的<code>{{user_id}}</code>会被中断消息中的同名键值替换。</p>
<blockquote>
<p>注意，<code>\Exception</code>中的getMessage()被标记为final，所以调用<code>$abort-&gt;getMessage()</code>不会触发模版机制。</p>
</blockquote>
<h1 id="page_section_6">调试方法</h1>
<h2 id="page_Helper">使用Helper类</h2>
<p>Combi提供了一个可扩展的Helper类，其默认提供了一些调试方法。</p>
<p>使用Helper方法时，建议使用use语句引用并设置别名<code>helper</code>（全小写）以便于使用：</p>
<pre><code class="language-php">use Combi {
    Helper as helper
};
</code></pre>
<blockquote>
<p>同样，使用脚手架工具创建的文件会自带上面的代码。</p>
</blockquote>
<p>Helper类中带有以下方法：</p>
<table>
<thead>
<tr>
<th>用例/方法</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>helper::register()</code></td>
</tr>
<tr>
<td><code>helper::logger()</code></td>
</tr>
<tr>
<td><code>helper::padding()</code></td>
</tr>
<tr>
<td><code>helper::invoke()</code></td>
</tr>
<tr>
<td><code>helper::namespace()</code></td>
</tr>
<tr>
<td><code>helper::make()</code></td>
</tr>
<tr>
<td><code>helper::instance()</code></td>
</tr>
<tr>
<td><code>helper::entityWithProcessor()</code></td>
</tr>
<tr>
<td><code>helper::confirm()</code></td>
</tr>
<tr>
<td><code>helper::stringify()</code></td>
</tr>
</tbody>
</table>
<p>以上方法因为是直接定义在Helper类中的。另外helper支持扩展方法。</p>
<h3 id="page_Helper-2">Helper扩展方法</h3>
<p>Helper类提供了一个重载方法，可以使用register()方法把一个闭包对象设置到静态方法调用中。例如：</p>
<pre><code class="language-php">helper::register(function(string $name): void {
    echo &quot;hello! $name.&quot;;
}, 'hello');

helper::hello('Lucy');
</code></pre>
<p>建议在包的<code>src/helpers.php</code>文件中定义扩展helper方法，并在<code>src/bootstrap.php</code>中使用<code>rt::register()</code>方法注册包时加入helper文件。</p>
<pre><code class="language-php">rt::register(Package::instance(__DIR__),
    'dependencies', 'helpers');
</code></pre>
<blockquote>
<p>对于这类扩展方法，可以以再次注册的形式覆盖之前定义的闭包对象。</p>
</blockquote>
<p>如果要取消一个已经定义的helper方法，可以传null值再注册一次：</p>
<pre><code class="language-php">helper::register(null, 'hello');
</code></pre>
<h2 id="page_section_8">调试输出</h2>
<p>Core包默认提供了一些调试用方法，这些方法在helpers.php中注册在了Helper类中。</p>
<p>使用<code>helper::du()</code>方法对要检查的变量调试输出。</p>
<pre><code class="language-php">helper::du($user);
</code></pre>
<p>如果变量是一个对象，du()方法会检查是否包括<code>toArray()</code>或是<code>__toString()</code>方法，有的话会调用。对于不同的输出环境，如页面或是命令行，du()指令也会尽量适配。</p>
<p>如果要打印的条目较多，希望加以区分，可以在输出时给定一个标题：</p>
<pre><code class="language-php">helper::du($user, 'user');
</code></pre>
<h3 id="page_section_9">调试并中止程序</h3>
<p>类似laravel，combi也提供了dd()方法：</p>
<pre><code class="language-php">helper::dd($user);
</code></pre>
<h3 id="page_section_10">获取代码段执行时间</h3>
<pre><code class="language-php">helper::timer();

// your code..

echo round(helper::timer() * 1000);
</code></pre>
<p><code>helper::timer()</code>方法第一次执行会初始化计数时间，第二次执行会返回与第一次计数时的时间差值。上面的代码会打印出以毫秒为单位的代码消耗时间。</p>
<h2 id="page_section_11">异常捕获</h2>
<p>combi框架默认的Catcher配置提供了以下全局处理机制：</p>
<ul>
<li>全局错误捕获，并将错误转换为ErrorException抛出</li>
<li>全局违例捕获，对未捕获的违例进行默认处理</li>
</ul>
<h3 id="page_section_12">错误转违例</h3>
<p>对于大多数的php错误，Catcher会将其转换为ErrorException对象抛出，并将错误发生所在作用域的环境变量带入context中。</p>
<h3 id="page_section_13">违例捕获</h3>
<p>对于未被try..catch语法捕获的错误，会记录日志。如果是非生产环境，会根据catcher配置，决定是否打印输出违例信息。</p>
<h1 id="page_section_14">日志系统</h1>
<p>Combi的日志系统基于流行的Monolog实现，便于扩展。</p>
<h2 id="page_section_15">日志配置</h2>
<p>Core包中的日志系统用一个单独的配置文件<code>logger.neon</code>进行配置。该配置使用了配置方法，对日志对象的创建及参数进行了描述。在默认状态下，配置了三个日志对象。</p>
<ul>
<li>combi 日志</li>
</ul>
<p>这是主要的日志对象，建议日常的日志都记录在这里。默认配置下，以按天滚动的形式记录在日志目录中的<code>combi-&lt;date&gt;.log</code>文件中，格式为json。</p>
<ul>
<li>slow 日志</li>
</ul>
<p>这是慢请求日志，在<code>setting.neon</code>可以配置慢请求的时长，默认是超过20毫秒即会触发记录。同样滚动记录在日志目录的<code>slow-&lt;date&gt;.log</code>文件中。</p>
<ul>
<li>debug 日志</li>
</ul>
<p>调试日志，推荐调试使用，将记录于日志目录的<code>debug.log</code>单一文件中，便于查看。</p>
<h2 id="page_section_16">记录日志</h2>
<p>Combi通过helper方法记录日志：</p>
<pre><code class="language-php">helper::info('some message.');
helper::error(new \Exception('something wrong.'));
helper::log($user);
</code></pre>
<p>可以看到，helper方法直接支持以错误级别名为方法名调用，这样默认会使用combi日志对象记录日志。如果是使用<code>helper::debug()</code>方法，则会使用debug日志对象记录。</p>
<p><code>helper::log()</code>其实是<code>helper::info()</code>的别名，适合用于在不确定日志级别时使用。</p>
<h2 id="page_section_17">自定义日志对象</h2>
<p>使用<code>helper::logger()</code>方法可以获取想要的logger对象，假设我们在logger.neon中自行定义了一个名为mylogger的日志对象：</p>
<pre><code class="language-php">$logger = helper::logger('mylogger');
$logger-&gt;info('some thing');
</code></pre>
<h2 id="page_section_18">日志的附加功能</h2>
<p>Combi提供了几个Processor和Handler，以供强化日志记录功能。</p>
<ul>
<li>RichMessageProcessor，提供了对富类型变量的日志支持。
<ul>
<li>能支持到各种类型的变量记录日志，比如违例、可序列化对象或是其他类型等，都可以直接记录日志。</li>
<li>经处理后，根据处理情况，在extra中添加了<code>abort, debugvars, throwable, raw</code>等字段。</li>
<li>对于info级别的日志，支持autolevel功能，会根据日志内容的类型对日志级别进行转换。</li>
</ul>
</li>
<li>PrimariesProcessor，对当前经历和处理的任务，以及用户身份ID做追踪。</li>
<li>SampleSnapHandler，如果日志的是一个<code>\Throwable</code>对象，则会对其完整信息记录一份不重复（默认按月不重复）的快照在日志目录的snaps目录下。</li>
</ul>
    </div>

        <nav>
        <ul class="Pager">
            <li class=Pager--prev><a href="../框架基础/配置系统.html">Previous</a></li>            <li class=Pager--next><a href="../框架基础/勾子与语言包.html">Next</a></li>        </ul>
    </nav>
    </article>

            </div>
        </div>
    </div>
</div>

    
    <!-- jQuery -->
    <script src="../themes/daux/js/jquery-1.11.3.min.js"></script>

    <!-- hightlight.js -->
    <script src="../themes/daux/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- JS -->
    
    <script src="../themes/daux/js/daux.js"></script>

            <!-- Tipue Search -->
        <script type="text/javascript" src="../tipuesearch/tipuesearch.js"></script>

        <script>
            window.onunload = function(){}; // force $(document).ready to be called on back/forward navigation in firefox
            $(function() {
                tipuesearch({
                    'base_url': '../'
                });
            });
        </script>
    
</body>
</html>
